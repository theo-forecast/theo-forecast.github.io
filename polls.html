<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Polls</title>
    <style>
        /* ... (previous CSS styles remain the same) ... */
    </style>
</head>
<body>

    <div class="button-container">
        <button onclick="openPage('index.html')">Model</button>
        <button onclick="openPage('polls.html')">Polls</button>
    </div>

    <h1>High Quality Polling Averages</h1>
    <p>This page provides the polling averages of a certain time period by high quality pollsters.</p>
    <ul style="text-align:center; color:#7f8c8d;">
        <li>June Debate - June 27</li>
        <li>Biden Dropped Out - July 22</li>
        <li>Harris v Trump Debate - Sept 10</li>
    </ul>

    <div class="states-container" id="statesContainer">
        <!-- State forecast cards will be dynamically inserted here -->
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        const states = [
            { name: 'National', range: 'A:C' },
            { name: 'Arizona', range: 'D:F' },
            { name: 'Florida', range: 'G:I' },
            { name: 'Georgia', range: 'J:L' },
            { name: 'Michigan', range: 'M:O' },
            { name: 'Minnesota', range: 'P:R' },
            { name: 'Nevada', range: 'S:U' },
            { name: 'New Hampshire', range: 'V:X' },
            { name: 'North Carolina', range: 'Y:AA' },
            { name: 'Pennsylvania', range: 'AB:AD' },
            { name: 'Wisconsin', range: 'AE:AG' }
        ];

        async function fetchExcelData() {
            try {
                const response = await fetch('https://theo-forecast.github.io/Polls.xlsx');
                const data = await response.arrayBuffer();
                const workbook = XLSX.read(data, { type: 'array' });
                const sheet = workbook.Sheets[workbook.SheetNames[0]];

                const statesContainer = document.getElementById('statesContainer');
                statesContainer.innerHTML = ''; // Clear existing content

                states.forEach((state, index) => {
                    const stateData = extractStateData(sheet, state.range);
                    const stateElement = createStateElement(state.name, index);
                    statesContainer.appendChild(stateElement);
                    updateTable(stateData, `pollsTable-${index}`);
                    updateChart(stateData, `chart-${index}`);
                });
            } catch (error) {
                console.error('Error fetching or processing the Excel file:', error);
                document.getElementById('statesContainer').innerHTML = '<p>Error loading data</p>';
            }
        }

        function extractStateData(sheet, range) {
            const [startCol, endCol] = range.split(':');
            const dates = XLSX.utils.sheet_to_json(sheet, { range: `${startCol}3:${startCol}15`, header: 1 }).map(row => row[0]);
            const harris = XLSX.utils.sheet_to_json(sheet, { range: `${String.fromCharCode(startCol.charCodeAt(0) + 1)}3:${String.fromCharCode(startCol.charCodeAt(0) + 1)}15`, header: 1 }).map(row => row[0]);
            const trump = XLSX.utils.sheet_to_json(sheet, { range: `${endCol}3:${endCol}15`, header: 1 }).map(row => row[0]);
            return { dates, harris, trump };
        }

        function createStateElement(stateName, index) {
            const stateElement = document.createElement('div');
            stateElement.className = 'state-forecast';
            stateElement.innerHTML = `
                <div class="header">
                    <div class="state">${stateName} Polling Average</div>
                </div>
                <div class="chart-container">
                    <canvas id="chart-${index}"></canvas>
                </div>
                <table id="pollsTable-${index}">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Harris</th>
                            <th>Trump</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Data rows will be inserted here -->
                    </tbody>
                </table>
            `;
            return stateElement;
        }

        function formatValue(value) {
            return value !== undefined && value !== null
                ? (value * 100).toFixed(2) + '%'
                : '-';
        }

        function updateTable(stateData, tableId) {
            const tableBody = document.querySelector(`#${tableId} tbody`);
            tableBody.innerHTML = '';
            stateData.dates.forEach((date, index) => {
                const row = `<tr>
                    <td>${date}</td>
                    <td>${formatValue(stateData.harris[index])}</td>
                    <td>${formatValue(stateData.trump[index])}</td>
                </tr>`;
                tableBody.innerHTML += row;
            });
        }

        function updateChart(stateData, chartId) {
            const ctx = document.getElementById(chartId).getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: stateData.dates,
                    datasets: [
                        {
                            label: 'Harris',
                            data: stateData.harris.map(value => value * 100),
                            borderColor: '#3498db',
                            backgroundColor: 'rgba(52, 152, 219, 0.2)',
                            borderWidth: 2,
                            fill: false
                        },
                        {
                            label: 'Trump',
                            data: stateData.trump.map(value => value * 100),
                            borderColor: '#e74c3c',
                            backgroundColor: 'rgba(231, 76, 60, 0.2)',
                            borderWidth: 2,
                            fill: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(tooltipItem) {
                                    return `${tooltipItem.dataset.label}: ${tooltipItem.raw}%`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            type: 'category',
                            labels: stateData.dates,
                        },
                        y: {
                            beginAtZero: false,
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        }
                    }
                }
            });
        }

        window.addEventListener('DOMContentLoaded', () => {
            fetchExcelData();
        });
    </script>
</body>
</html>
